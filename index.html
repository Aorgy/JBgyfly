<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard บริหารเงิน</title>

  <!-- Tailwind / Chart.js -->
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <!-- ฟอนต์ไทย -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Sarabun', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card { background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .allocation-bar{ transition: width .5s ease-in-out; }
    .pulse{ animation:pulse 2s infinite; } @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

    /* === Modal: ใช้คลาส .open เพื่อโชว์ (แก้เคสคลิกไม่ได้) === */
    .modal{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);
      z-index:9999; align-items:center; justify-content:center;
    }
    .modal.open{ display:flex; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Header -->
  <header class="gradient-bg text-white p-6">
    <div class="max-w-7xl mx-auto">
      <div class="flex justify-between items-center mb-2">
        <h1 class="text-3xl font-bold">💰 Dashboard บริหารเงิน</h1>
        <div class="flex items-center gap-3">
          <div class="bg-white/20 rounded-lg px-4 py-2">
            <div class="flex items-center gap-2">
              <span class="text-lg font-semibold" id="currentMonth">—</span>
              <span class="text-sm">📅</span>
            </div>
          </div>
          <div class="bg-white/20 rounded-lg px-3 py-2 text-sm" id="lastUpdate">อัพเดทล่าสุด: —</div>
        </div>
      </div>
      <p class="text-blue-100">
        กฎ 3 ส่วน: รายรับ ÷ 3 = กิน / หนี้ / ลงทุน | เหลือจาก กิน/หนี้ → ทบลงทุน | ลงทุนกัน 10% เป็นเงินสำรองฉุกเฉิน |
        Crypto: BTC ตาม % ย่อ, ที่เหลือ All-in KUB
      </p>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6 space-y-8">

    <!-- Summary -->
    <section class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-7 gap-4">
      <div class="card p-6 border-l-4 border-purple-500">
        <div class="flex justify-between">
          <div>
            <p class="text-gray-600 text-sm">รายรับ</p>
            <p class="text-2xl font-bold" id="totalIncome">฿0</p>
          </div>
          <div class="bg-purple-100 p-3 rounded-full">💵</div>
        </div>
      </div>

      <div class="card p-6 border-l-4 border-orange-500">
        <div class="flex justify-between">
          <div>
            <p class="text-gray-600 text-sm">กิน</p>
            <p class="text-2xl font-bold text-orange-600" id="foodExpense">฿0</p>
            <p class="text-xs text-gray-500">งบ <span id="foodBudget">฿0</span></p>
            <div class="w-full bg-gray-200 h-1.5 mt-1 rounded-full">
              <div id="foodProgress" class="bg-orange-500 h-1.5 rounded-full" style="width:0%"></div>
            </div>
          </div>
          <div class="bg-orange-100 p-3 rounded-full">🍽️</div>
        </div>
      </div>

      <div class="card p-6 border-l-4 border-red-500">
        <div class="flex justify-between">
          <div>
            <p class="text-gray-600 text-sm">หนี้</p>
            <p class="text-2xl font-bold text-red-600" id="debtExpense">฿0</p>
            <p class="text-xs text-gray-500">งบ <span id="debtBudget">฿0</span></p>
            <div class="w-full bg-gray-200 h-1.5 mt-1 rounded-full">
              <div id="debtProgress" class="bg-red-500 h-1.5 rounded-full" style="width:0%"></div>
            </div>
          </div>
          <div class="bg-red-100 p-3 rounded-full">💳</div>
        </div>
      </div>

      <div class="card p-6 border-l-4 border-green-500">
        <div class="flex justify-between">
          <div>
            <p class="text-gray-600 text-sm">ลงทุนรวม</p>
            <p class="text-2xl font-bold text-green-600" id="totalInvestment">฿0</p>
            <p class="text-xs text-gray-500">งบ <span id="investmentBudget">฿0</span></p>
            <div class="w-full bg-gray-200 h-1.5 mt-1 rounded-full">
              <div id="investmentProgress" class="bg-green-500 h-1.5 rounded-full" style="width:0%"></div>
            </div>
          </div>
          <div class="bg-green-100 p-3 rounded-full">📈</div>
        </div>
      </div>

      <div class="card p-6 border-l-4 border-orange-300">
        <div class="flex justify-between">
          <div>
            <p class="text-gray-600 text-sm">เหลือจากกิน</p>
            <p class="text-2xl font-bold text-orange-500" id="foodRemaining">฿0</p>
          </div>
          <div class="bg-orange-50 p-3 rounded-full">💰</div>
        </div>
      </div>

      <div class="card p-6 border-l-4 border-red-300">
        <div class="flex justify-between">
          <div>
            <p class="text-gray-600 text-sm">เหลือจากหนี้</p>
            <p class="text-2xl font-bold text-red-500" id="debtRemaining">฿0</p>
          </div>
          <div class="bg-red-50 p-3 rounded-full">💸</div>
        </div>
      </div>

      <div class="card p-6 border-l-4 border-blue-500">
        <div class="flex justify-between">
          <div>
            <p class="text-gray-600 text-sm">เงินสำรองฉุกเฉิน</p>
            <p class="text-2xl font-bold text-blue-600" id="emergencyFund">฿0</p>
            <p class="text-xs text-blue-500">10% ของลงทุน</p>
          </div>
          <div class="bg-blue-100 p-3 rounded-full">🛡️</div>
        </div>
      </div>
    </section>

    <!-- Charts + Flow -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Donut -->
      <div class="card p-6">
        <h3 class="text-xl font-bold mb-4">📊 การแบ่งเงิน</h3>
        <div class="relative h-80"><canvas id="donutChart"></canvas></div>
      </div>

      <!-- Flow -->
      <div class="card p-6">
        <h3 class="text-xl font-bold mb-4">🔄 แผนผังไหลของเงิน</h3>
        <div class="space-y-4">
          <div class="text-center">
            <div class="bg-purple-100 rounded-lg p-4 inline-block">
              <span class="text-lg font-bold text-purple-700" id="incomeBadge">รายรับ —</span>
            </div>
          </div>
          <div class="text-center text-xs text-gray-500">แบ่ง 3 ส่วนเท่า ๆ กัน</div>

          <div class="grid grid-cols-3 gap-2">
            <div class="bg-orange-100 rounded-lg p-3 text-center">
              <div class="text-sm font-medium text-orange-700">กิน</div>
              <div class="text-lg font-bold text-orange-600" id="flowFood">—</div>
              <div class="text-xs text-orange-500" id="flowFoodRemain">เหลือ —</div>
            </div>
            <div class="bg-red-100 rounded-lg p-3 text-center">
              <div class="text-sm font-medium text-red-700">หนี้</div>
              <div class="text-lg font-bold text-red-600" id="flowDebt">—</div>
              <div class="text-xs text-red-500" id="flowDebtRemain">เหลือ —</div>
            </div>
            <div class="bg-green-100 rounded-lg p-3 text-center">
              <div class="text-sm font-medium text-green-700">ลงทุนฐาน</div>
              <div class="text-lg font-bold text-green-600" id="flowInvestBase">—</div>
            </div>
          </div>

          <div class="text-center">
            <div class="bg-green-200 rounded-lg p-3 inline-block">
              <div class="text-sm text-green-700" id="flowSumText">—</div>
              <div class="text-lg font-bold text-green-600" id="flowInvestTotal">= ลงทุนรวม —</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="bg-blue-100 rounded-lg p-3 text-center">
              <div class="text-sm font-medium text-blue-700">สำรองฉุกเฉิน</div>
              <div class="text-lg font-bold text-blue-600" id="flowEmergency">—</div>
            </div>
            <div class="bg-green-200 rounded-lg p-3 text-center">
              <div class="text-sm font-medium text-green-700">ลงทุนสุทธิ</div>
              <div class="text-lg font-bold text-green-600" id="flowNetInvest">—</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- BTC -->
    <section class="card p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">₿ BTC/USD Real-Time Price Tracking</h3>
        <div class="flex items-center gap-2"><span class="w-3 h-3 bg-green-500 rounded-full pulse"></span><span class="text-sm text-gray-600">Live Data</span></div>
      </div>

      <!-- Stat Cards -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-gradient-to-br from-orange-400 to-orange-600 p-4 rounded-lg text-white text-center">
          <div class="text-xs opacity-80">All-Time High</div>
          <div class="text-xl font-bold" id="btcATH">$—</div>
          <div class="text-xs opacity-80" id="btcAthDate">—</div>
        </div>
        <div class="bg-gradient-to-br from-blue-500 to-blue-700 p-4 rounded-lg text-white text-center">
          <div class="text-xs opacity-80">Current Price</div>
          <div class="text-xl font-bold" id="btcCurrent">$—</div>
          <div class="text-xs opacity-80" id="priceChange">—</div>
        </div>
        <div class="bg-gradient-to-br from-red-500 to-red-700 p-4 rounded-lg text-white text-center">
          <div class="text-xs opacity-80">% From ATH</div>
          <div class="text-xl font-bold" id="btcDropFromATH">—</div>
          <div class="text-xs opacity-80">Drop Amount</div>
        </div>
        <div class="bg-gradient-to-br from-green-500 to-green-700 p-4 rounded-lg text-white text-center">
          <div class="text-xs opacity-80">BTC Allocation</div>
          <div class="text-xl font-bold" id="btcAllocation">—</div>
          <div class="text-xs opacity-80">Auto-Adjusted</div>
        </div>
        <div class="bg-gradient-to-br from-purple-500 to-purple-700 p-4 rounded-lg text-white text-center">
          <div class="text-xs opacity-80">Market Cap Rank</div>
          <div class="text-xl font-bold">#1</div>
          <div class="text-xs opacity-80">Crypto Leader</div>
        </div>
      </div>

      <!-- Controls -->
      <div class="bg-gray-50 p-6 rounded-lg">
        <h4 class="font-semibold mb-4">💹 Price Control Center</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Manual BTC Price Update</label>
              <div class="flex gap-2">
                <div class="relative flex-1">
                  <span class="absolute left-3 top-2 text-gray-500">$</span>
                  <input id="btcPriceInput" type="number" min="1000" max="200000" step="50" placeholder="เช่น 102500"
                         class="w-full pl-8 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
                </div>
                <button id="btnPriceUpdate" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium">Update</button>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-2">
              <button id="btnQuick95"  class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded text-sm font-medium">$95K</button>
              <button id="btnQuick100" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-3 py-2 rounded text-sm font-medium">$100K</button>
              <button id="btnQuick105" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded text-sm font-medium">$105K</button>
            </div>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Live Data</label>
              <div class="space-y-2">
                <button id="btnFetchLive" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">🔄 Fetch Live Price</button>
                <button id="btnAutoUpdate" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium">⚡ Start Auto-Update (5min)</button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Price Alerts</label>
              <div class="flex gap-2">
                <input id="alertPrice" type="number" min="1000" max="200000" placeholder="Alert at $…"
                       class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                <button id="btnSetAlert" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm font-medium">Set Alert</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Price chart -->
      <div class="bg-gray-50 p-4 rounded-lg mt-4">
        <div class="relative h-44"><canvas id="btcPriceChart"></canvas></div>
      </div>
    </section>

    <!-- Transactions + Actions -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Table -->
      <div class="lg:col-span-2 card p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">📋 ธุรกรรมล่าสุด</h3>
          <div class="flex gap-2">
            <button class="filter-btn bg-blue-500 text-white px-3 py-1 rounded text-sm" data-filter="all">ทั้งหมด</button>
            <button class="filter-btn bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm" data-filter="รายรับ">รายรับ</button>
            <button class="filter-btn bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm" data-filter="รายจ่าย">รายจ่าย</button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-gray-200">
                <th class="text-left py-3 px-4">วันที่</th>
                <th class="text-left py-3 px-4">รายการ</th>
                <th class="text-left py-3 px-4">ประเภท</th>
                <th class="text-right py-3 px-4">จำนวน</th>
                <th class="text-center py-3 px-4">การดำเนินการ</th>
              </tr>
            </thead>
            <tbody id="transactionTable"></tbody>
          </table>
        </div>
        <div class="flex justify-between items-center mt-4 text-sm text-gray-500">
          <span id="tableCount">ทั้งหมด 0 รายการ</span>
        </div>
      </div>

      <!-- Actions -->
      <div class="space-y-6">
        <div class="card p-6">
          <h3 class="text-xl font-bold mb-4">⚡ การดำเนินการ</h3>
          <div class="space-y-3">
            <button id="btnAddIncome"  class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg">💰 เพิ่มรายรับ</button>
            <button id="btnAddExpense" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg">📝 บันทึกรายจ่าย</button>
            <button id="btnReport"     class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg">📊 ดูรายงาน</button>
            <button id="btnGoals"      class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg">🎯 ตั้งเป้าหมาย</button>
          </div>
        </div>

        <div class="card p-6">
          <h3 class="text-lg font-bold mb-4">🔔 การแจ้งเตือน</h3>
          <div id="alertPanel" class="text-sm text-gray-700">—</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modals (ใช้ .open แทน .hidden) -->
  <div id="incomeModal" class="modal">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">💰 เพิ่มรายรับ</h3>
        <button class="text-gray-500 hover:text-gray-700" id="closeIncome">×</button>
      </div>
      <form id="incomeForm" class="space-y-4">
        <div><label class="block text-sm mb-2">รายการ</label><input id="incomeDescription" class="w-full px-3 py-2 border rounded-lg" placeholder="เงินเดือน / โบนัส"></div>
        <div><label class="block text-sm mb-2">จำนวนเงิน (บาท)</label><input id="incomeAmount" type="number" min="0" step="0.01" class="w-full px-3 py-2 border rounded-lg" placeholder="0"></div>
        <div><label class="block text-sm mb-2">วันที่</label><input id="incomeDate" type="date" class="w-full px-3 py-2 border rounded-lg"></div>
        <div class="flex gap-3 pt-2">
          <button type="button" class="flex-1 bg-gray-300 py-2 rounded-lg" id="cancelIncome">ยกเลิก</button>
          <button type="button" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg" id="saveIncome">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <div id="expenseModal" class="modal">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">📝 บันทึกรายจ่าย</h3>
        <button class="text-gray-500 hover:text-gray-700" id="closeExpense">×</button>
      </div>
      <form id="expenseForm" class="space-y-4">
        <div><label class="block text-sm mb-2">รายการ</label><input id="expenseDescription" class="w-full px-3 py-2 border rounded-lg" placeholder="ค่าอาหาร / ผ่อนบ้าน"></div>
        <div><label class="block text-sm mb-2">ประเภท</label>
          <select id="expenseType" class="w-full px-3 py-2 border rounded-lg">
            <option value="">เลือกประเภท</option>
            <option value="กิน">🍽️ กิน</option>
            <option value="หนี้">💳 หนี้</option>
            <option value="ลงทุน">📈 ลงทุน</option>
            <option value="สำรอง">🛡️ สำรอง</option>
          </select>
        </div>
        <div><label class="block text-sm mb-2">จำนวนเงิน (บาท)</label><input id="expenseAmount" type="number" min="0" step="0.01" class="w-full px-3 py-2 border rounded-lg" placeholder="0"></div>
        <div><label class="block text-sm mb-2">วันที่</label><input id="expenseDate" type="date" class="w-full px-3 py-2 border rounded-lg"></div>
        <div class="flex gap-3 pt-2">
          <button type="button" class="flex-1 bg-gray-300 py-2 rounded-lg" id="cancelExpense">ยกเลิก</button>
          <button type="button" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg" id="saveExpense">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- CONFIG -->
  <script>
    // ลิงก์ Apps Script ของคุณ
    const CONFIG = {
      WEBAPP_URL: 'https://script.google.com/macros/s/AKfycbx7xLBsdHc_WxYCTvOl-3AoKjnDfFpudZDctaUUww5KzKNQpitXZ9GedXr-vHjY2Mg_/exec'
    };
  </script>

  <!-- APP JS -->
  <script>
    /***********************
     * Utilities / Globals *
     ***********************/
    const TH_MONTHS=['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
    const fmtTHB = n => '฿' + Number(n||0).toLocaleString('th-TH');
    const THtoAD = y => (y>2400? y-543:y);

    let donutChart, btcPriceChart;
    let priceHistory=[], autoUpdateInterval=null;
    let btcATH=108000, btcCurrentPrice=102500;
    let currentYear, currentMonth;
    let netInvestment = 0; // อัปเดตจากสรุป

    const $ = id => document.getElementById(id);

    /*******************
     * Modal handlers  *
     *******************/
    const openModal = id => $(id).classList.add('open');
    const closeModal = id => $(id).classList.remove('open');

    /*******************
     * Apps Script I/O *
     *******************/
    async function loadFromWebApp(yearTH, monthIndex){
      const y = THtoAD(yearTH);
      const res = await fetch(`${CONFIG.WEBAPP_URL}?year=${y}&month=${monthIndex}`);
      if(!res.ok) throw new Error('โหลดข้อมูลไม่สำเร็จ');
      const j = await res.json();
      if(!j.ok) throw new Error(j.error||'WebApp error');
      return j.transactions || [];
    }

    async function postTransaction(tx){
      const res = await fetch(CONFIG.WEBAPP_URL, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain; charset=utf-8' }, // ถูกกับ Apps Script
        body: JSON.stringify(tx)
      });
      const text = await res.text();
      let j; try{ j=JSON.parse(text);}catch(e){ throw new Error('WebApp ไม่ได้ตอบเป็น JSON (เช็ค deployment เป็น Anyone)');}
      if(!res.ok || !j.ok) throw new Error(j?.error || ('HTTP '+res.status));
      return true;
    }

    /*******************
     * Compute & Render*
     *******************/
    function computeFromTransactions(rows){
      let income=0, food=0, debt=0;
      rows.forEach(r=>{
        const amt = Number(r.amount)||0;
        if(amt>0){ income+=amt; }
        else{
          if(r.type==='กิน')  food += -amt;
          if(r.type==='หนี้')  debt += -amt;
        }
      });

      const base = Math.floor(income/3);
      const foodRemain = Math.max(base - food, 0);
      const debtRemain = Math.max(base - debt, 0);
      const investTotal = base + foodRemain + debtRemain;
      const emergency = Math.floor(investTotal*0.10);
      const netInvest = investTotal - emergency;

      return {income, food, debt, foodBudget:base, debtBudget:base, investBase:base,
              foodRemain, debtRemain, investTotal, emergency, netInvest};
    }

    function applySummaryToUI(m){
      $('totalIncome').textContent      = fmtTHB(m.income);
      $('foodExpense').textContent      = fmtTHB(m.food);
      $('debtExpense').textContent      = fmtTHB(m.debt);
      $('foodBudget').textContent       = fmtTHB(m.foodBudget);
      $('debtBudget').textContent       = fmtTHB(m.debtBudget);
      $('totalInvestment').textContent  = fmtTHB(m.investTotal);
      $('investmentBudget').textContent = fmtTHB(m.investBase);
      $('foodRemaining').textContent    = fmtTHB(m.foodRemain);
      $('debtRemaining').textContent    = fmtTHB(m.debtRemain);
      $('emergencyFund').textContent    = fmtTHB(m.emergency);

      $('incomeBadge').textContent      = `รายรับ ${fmtTHB(m.income)}`;
      $('flowFood').textContent         = fmtTHB(Math.min(m.food, m.foodBudget));
      $('flowDebt').textContent         = fmtTHB(Math.min(m.debt, m.debtBudget));
      $('flowInvestBase').textContent   = fmtTHB(m.investBase);
      $('flowFoodRemain').textContent   = `เหลือ ${fmtTHB(m.foodRemain)}`;
      $('flowDebtRemain').textContent   = `เหลือ ${fmtTHB(m.debtRemain)}`;
      $('flowSumText').textContent      = `เงินเหลือ ${fmtTHB(m.foodRemain + m.debtRemain)} + ลงทุนฐาน ${fmtTHB(m.investBase)}`;
      $('flowInvestTotal').textContent  = `= ลงทุนรวม ${fmtTHB(m.investTotal)}`;
      $('flowEmergency').textContent    = fmtTHB(m.emergency);
      $('flowNetInvest').textContent    = fmtTHB(m.netInvest);

      $('foodProgress').style.width = (m.foodBudget? Math.min(100, m.food/m.foodBudget*100):0) + '%';
      $('debtProgress').style.width = (m.debtBudget? Math.min(100, m.debt/m.debtBudget*100):0) + '%';
      $('investmentProgress').style.width = (m.investBase? Math.min(150, m.investTotal/m.investBase*100):0) + '%';

      // donut
      donutChart.data.labels=['กิน','หนี้','ลงทุนสุทธิ','เงินสำรอง'];
      donutChart.data.datasets[0].data=[m.food, m.debt, m.netInvest, m.emergency];
      donutChart.update();

      netInvestment = m.netInvest;
      updateBTCAllocation(); // sync ส่วน crypto
      $('lastUpdate').textContent = `อัพเดทล่าสุด: ${new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}`;
    }

    function renderTransactionsTable(rows){
      const tbody = $('transactionTable'); tbody.innerHTML='';
      const badge = {
        'รายรับ':'bg-purple-100 text-purple-700',
        'กิน':'bg-orange-100 text-orange-700',
        'หนี้':'bg-red-100 text-red-700',
        'ลงทุน':'bg-green-100 text-green-700',
        'สำรอง':'bg-blue-100 text-blue-700'
      };
      rows.slice().reverse().forEach(r=>{
        const tr=document.createElement('tr');
        tr.className='border-b border-gray-100 hover:bg-gray-50 transaction-row';
        tr.dataset.type = Number(r.amount)>=0? 'รายรับ':'รายจ่าย';
        tr.innerHTML = `
          <td class="py-3 px-4 text-gray-600">${new Date(r.date).toLocaleDateString('th-TH')}</td>
          <td class="py-3 px-4 text-gray-800">${r.description}</td>
          <td class="py-3 px-4"><span class="${badge[r.type]||'bg-gray-100 text-gray-700'} px-2 py-1 rounded-full text-xs font-medium">${r.type}</span></td>
          <td class="py-3 px-4 text-right font-semibold ${Number(r.amount)>=0?'text-green-600':'text-red-600'}">${Number(r.amount)>=0?'+':''}${fmtTHB(Math.abs(r.amount))}</td>
          <td class="py-3 px-4 text-center"><button class="text-blue-500 hover:text-blue-700 text-xs" disabled>แก้ไข</button></td>`;
        tbody.appendChild(tr);
      });
      $('tableCount').textContent = `ทั้งหมด ${rows.length} รายการ`;
    }

    /***************
     * BTC Section *
     ***************/
    const calcDrop = (cur, ath) => ( (cur - ath)/ath*100 );
    const getBTCWeight = drop => (drop>=-5?40 : drop>=-10?60 : drop>=-15?80 : 100);

    function updateBTCAllocation(){
      const d = calcDrop(btcCurrentPrice, btcATH);
      const w = getBTCWeight(d);
      $('btcATH').textContent = `$${btcATH.toLocaleString()}`;
      $('btcCurrent').textContent = `$${btcCurrentPrice.toLocaleString()}`;
      $('btcDropFromATH').textContent = `${d.toFixed(1)}%`;
      $('priceChange').textContent = `${d>=0?'+':''}$${(btcCurrentPrice-btcATH).toLocaleString()}`;
      $('btcAllocation').textContent = `${w}%`;
    }

    function addToPriceHistory(price){
      const now = new Date();
      priceHistory.push({ time: now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}), price:Math.round(price) });
      if(priceHistory.length>30) priceHistory.shift();
      // update chart
      btcPriceChart.data.labels = priceHistory.map(x=>x.time);
      btcPriceChart.data.datasets[0].data = priceHistory.map(x=>x.price);
      btcPriceChart.data.datasets[1].data = priceHistory.map(()=>btcATH);
      btcPriceChart.update('none');
    }

    async function fetchBTCMeta(){
      try{
        const r = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false');
        const d = await r.json();
        btcATH = Math.round(d.market_data.ath.usd);
        const athDate = new Date(d.market_data.ath_date.usd);
        $('btcAthDate').textContent = athDate.toLocaleDateString('en-US',{month:'short',year:'numeric'});
        btcCurrentPrice = Math.round(d.market_data.current_price.usd);
        addToPriceHistory(btcCurrentPrice);
        updateBTCAllocation();
      }catch(e){
        // ใช้ค่า default ถ้าดึงไม่ได้
        updateBTCAllocation();
      }
    }

    /****************
     * Init Charts  *
     ****************/
    function initDonut(){
      donutChart = new Chart($('donutChart').getContext('2d'),{
        type:'doughnut',
        data:{ labels:[], datasets:[{ data:[0,0,0,0], backgroundColor:['#F59E0B','#EF4444','#16A34A','#3B82F6'], borderWidth:0, cutout:'60%' }]},
        options:{ plugins:{legend:{display:false}}, maintainAspectRatio:false }
      });
    }
    function initPriceChart(){
      btcPriceChart = new Chart($('btcPriceChart').getContext('2d'),{
        type:'line',
        data:{ labels:[], datasets:[
          { label:'BTC', data:[], borderColor:'#F59E0B', backgroundColor:'rgba(245,158,11,.12)', borderWidth:2, fill:true, tension:.35, pointRadius:2 },
          { label:'ATH', data:[], borderColor:'#EF4444', borderWidth:1, borderDash:[5,5], fill:false, pointRadius:0 }
        ]},
        options:{ plugins:{legend:{display:false}}, maintainAspectRatio:false, scales:{ y:{ ticks:{ callback:v=>'$'+Number(v).toLocaleString() }}}}
      });
    }

    /***************
     * Actions UI  *
     ***************/
    async function refreshDashboard(){
      try{
        const tx = await loadFromWebApp(currentYear, currentMonth);
        renderTransactionsTable(tx);
        applySummaryToUI(computeFromTransactions(tx));
      }catch(e){
        alert('โหลดข้อมูลไม่สำเร็จ: '+e.message);
      }
    }

    function bindFilters(){
      document.querySelectorAll('.filter-btn').forEach(btn=>{
        btn.addEventListener('click', ev=>{
          document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('bg-blue-500','text-white'));
          btn.classList.add('bg-blue-500','text-white');
          const type = btn.dataset.filter;
          document.querySelectorAll('#transactionTable .transaction-row').forEach(row=>{
            if(type==='all') row.style.display='';
            else if(type==='รายรับ') row.style.display = (row.dataset.type==='รายรับ')?'':'none';
            else row.style.display = (row.dataset.type!=='รายรับ')?'':'none';
          });
        });
      });
    }

    /***************
     * DOMContent  *
     ***************/
    document.addEventListener('DOMContentLoaded', ()=>{
      // วันเริ่มต้น
      const today = new Date().toISOString().split('T')[0];
      $('incomeDate').value = today; $('expenseDate').value = today;

      // เดือนปัจจุบัน (พ.ศ.)
      const now = new Date(); currentYear = now.getFullYear()+543; currentMonth = now.getMonth();
      $('currentMonth').textContent = `${TH_MONTHS[currentMonth]} ${currentYear}`;

      // Charts
      initDonut(); initPriceChart();
      // Seed history 10 จุด
      for(let i=9;i>=0;i--){ const t=new Date(now.getTime()-i*60000); const p=btcCurrentPrice+(Math.random()-.5)*800;
        priceHistory.push({ time:t.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}), price:Math.round(Math.max(p,30000)) });
      }
      btcPriceChart.data.labels = priceHistory.map(x=>x.time);
      btcPriceChart.data.datasets[0].data = priceHistory.map(x=>x.price);
      btcPriceChart.data.datasets[1].data = priceHistory.map(()=>btcATH);
      btcPriceChart.update();

      // ดึงราคา/ATH จริง
      fetchBTCMeta();

      // โหลดข้อมูลชีต
      refreshDashboard();

      // ===== bind buttons (ใช้ event listener แทน inline เพื่อเสถียร) =====
      $('btnAddIncome').addEventListener('click', ()=>{ openModal('incomeModal'); setTimeout(()=>$('incomeDescription').focus(),50); });
      $('btnAddExpense').addEventListener('click', ()=>{ openModal('expenseModal'); setTimeout(()=>$('expenseDescription').focus(),50); });
      $('btnReport').addEventListener('click', ()=>alert('Reports: Coming soon'));
      $('btnGoals').addEventListener('click', ()=>alert('Goals: Coming soon'));
      $('closeIncome').addEventListener('click', ()=>closeModal('incomeModal'));
      $('cancelIncome').addEventListener('click', ()=>closeModal('incomeModal'));
      $('closeExpense').addEventListener('click', ()=>closeModal('expenseModal'));
      $('cancelExpense').addEventListener('click', ()=>closeModal('expenseModal'));

      // Save income
      $('saveIncome').addEventListener('click', async ()=>{
        const description = $('incomeDescription').value.trim();
        const amount = parseFloat($('incomeAmount').value);
        const date = $('incomeDate').value;
        if(!description || !amount || !date){ alert('กรอกข้อมูลให้ครบ'); return; }
        try{
          await postTransaction({ date, description, type:'รายรับ', amount: amount });
          closeModal('incomeModal'); $('incomeForm').reset(); $('incomeDate').value=today;
          refreshDashboard();
        }catch(e){ alert('บันทึกไม่สำเร็จ: '+e.message); }
      });

      // Save expense
      $('saveExpense').addEventListener('click', async ()=>{
        const description = $('expenseDescription').value.trim();
        const type = $('expenseType').value;
        const amount = parseFloat($('expenseAmount').value);
        const date = $('expenseDate').value;
        if(!description || !type || !amount || !date){ alert('กรอกข้อมูลให้ครบ'); return; }
        try{
          await postTransaction({ date, description, type, amount: -Math.abs(amount) });
          closeModal('expenseModal'); $('expenseForm').reset(); $('expenseDate').value=today;
          refreshDashboard();
        }catch(e){ alert('บันทึกไม่สำเร็จ: '+e.message); }
      });

      // BTC controls
      $('btnPriceUpdate').addEventListener('click', ()=>{
        const v = parseFloat($('btcPriceInput').value);
        if(!v||v<=0) return; btcCurrentPrice=v; addToPriceHistory(v); updateBTCAllocation(); $('btcPriceInput').value='';
      });
      $('btnQuick95').addEventListener('click', ()=>{ btcCurrentPrice=95000; addToPriceHistory(95000); updateBTCAllocation(); });
      $('btnQuick100').addEventListener('click', ()=>{ btcCurrentPrice=100000; addToPriceHistory(100000); updateBTCAllocation(); });
      $('btnQuick105').addEventListener('click', ()=>{ btcCurrentPrice=105000; addToPriceHistory(105000); updateBTCAllocation(); });
      $('btnFetchLive').addEventListener('click', async ()=>{
        try{
          const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
          const d=await r.json(); btcCurrentPrice=Math.round(d.bitcoin.usd);
          addToPriceHistory(btcCurrentPrice); updateBTCAllocation();
        }catch(e){ alert('ดึงราคาสดไม่สำเร็จ'); }
      });
      $('btnAutoUpdate').addEventListener('click', async (ev)=>{
        const btn=ev.currentTarget;
        if(autoUpdateInterval){ clearInterval(autoUpdateInterval); autoUpdateInterval=null; btn.textContent='⚡ Start Auto-Update (5min)'; }
        else{ autoUpdateInterval=setInterval(()=>$('btnFetchLive').click(), 300000); btn.textContent='⏹️ Stop Auto-Update'; $('btnFetchLive').click(); }
      });
      $('btnSetAlert').addEventListener('click', ()=>{
        const p=parseFloat($('alertPrice').value); if(!p||p<=0) return; $('alertPanel').textContent=`Alert set at $${p.toLocaleString()}`;
        $('alertPrice').value='';
      });

      bindFilters();
    });
  </script>
</body>
</html>